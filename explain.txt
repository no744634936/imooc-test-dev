npm i -g lerna //先在自己的电脑上添加个lerna
npm i -D lerna
lerna init


写.gitignore 文件
----
node_modules
.vscode
.idea
packages/**/node_modules
core/**/node_modules
utils/**/node_modules
models/**/node_modules
commands/**/node_modules

core/**/package-lock.json
utils/**/package-lock.json
models/**/package-lock.json
commands/**/package-lock.json
lerna-debug.log
package-lock.json
----


写lerna.json 文件
----
"packages": [
    "",
    "core/*",
    "commands/*",
    "utils/*",
    "models/*"
],
----


拆包

建立，core，models，utils ，command 四个文件夹


创建npm的项目

lerna create cli core

-----
package name 写上 @imooc-cli-dev-zhang/cli
version 写上1.0.0
description 写上 imooc-cli-dev-zhang cli
-----
core文件夹里面就会有一个 自动生成 cli/lib/cli.js 文件



lerna create utils utils
-----
package name 写上 @imooc-cli-dev-zhang/utils
version 写上1.0.0
description 写上 imooc-cli-dev-zhang utils
-----
utils文件夹里面就会有一个 自动生成 utils/lib/utils.js 文件




@imooc-cli-dev-zhang 就是npm 管理画面里的组织名,这个group必须要建立，不容易名字产生冲突
去npm 管理画面
点击 add orgnizition
输入imooc-cli-dev
点击create



修改core/cli/package.json文件里的dependencies
-------------
"dependencies": {
"@imooc-cli-dev-zhang/utils": "file:../../utils/utils"
},

如果你在dependencies配置的版本信息是"file:xx" 使用npm install 后node_modules中添加的还是本地的包，
如果dependencies中配置的是具体的版本号, npm intall 会去找线上发布的包。


然后再 core/cli文件夹下建立一个bin/index.js 文件
里面写上:
#!/usr/bin/env node
console.log("test")

然后在 core/cli/package.json文件里面写上
"bin": {
    "imooc-test-dev": "bin/index.js"
}

cd 到core/cli文件夹下 npm link

这个命令回给当前的包下载依赖，还会在
C:\Users\zhang\AppData\Roaming\npm 文件夹里生成 imooc-test-dev.cmd 文件

C:\Users\zhang\AppData\Roaming\npm\imooc-test-dev -> C:\Users\zhang\AppData\Roaming\npm\node_modules\@imooc-cli-dev-zhang\cli\bin\index.js
C:\Users\zhang\AppData\Roaming\npm\node_modules\@imooc-cli-dev-zhang\cli -> C:\Users\zhang\Desktop\imooc-test\core\cli

当在任意文件夹下运行 imooc-test-dev 命令时
操作系统会去去环境变量中找是否有 imooc-test-dev.cmd 命令
环境变量里有 C:\Users\zhang\AppData\Roaming\npm 这个路径
在这个路径下找到了  imooc-test-dev 这个文件指向的是imooc-test-dev.cmd

imooc-test-dev.cmd 指向的是
C:\Users\zhang\AppData\Roaming\npm\node_modules\@imooc-cli-dev-zhang\cli\bin\index.js
这个文件
因为index.js 文件里有这样一行代码
#!/usr/bin/env node
告诉系统去环境变量中找node 命令来执行这个index.js 文件

环境变量中的C:\Users\zhang\AppData\Roaming\npm 是在下载node.js的时候就已经安装好了的
如何查看环境变量 echo $PATH
如果查看vue命令指向那个文件 which vue

-------------------
如果写的是
"dependencies": {
"@imooc-cli-dev-zhang/utils": "^1.0.0"
},
那么可以直接使用 lerna link 来做软连接
-------------



做完上面哪些步骤就可以在任意文件夹下的terminal里面运行了

core/cli文件夹下
npm i -S import-local
npm i -S npmlog

修改这两个文件
core/cli/bin/indes.js
core/cli/lib/indes.js



// 检查项目版本号，检查node版本，检查root权限自动降级，检查用户主目录,检查输入的参数，检查环境变量
修改core/cli/bin/index.js 文件
修改core/cli/lib/index.js 文件
修改utils/log/lib/index.js 文件
修改utils/get-npm-info/lib/index.js 文件


//检查版本号的功能
// 在utils 里面建立log包
lerna create  @imooc-cli-dev-zhang/log utils/

使用 lerna add npmlog utils/log/ 命令在log文件夹里面安装npmlog 依赖
使用lerna 的好处就是不用特意到utils/log/包之下去输入 npm install log -s
在任何目录下 lerna add npmlog utils/log/ 就可以将npmlog 安装到 utils/log/ 

//在core/cli里面使用log包

core/cli/package.json里面写入
-----
"@imooc-cli-dev-zhang/log": "file:../../utils/log",
------
cd 到\imooc-test\core\cli 目录 然后执行 npm link(npm unlink 之后再次npm link)



//检查node时否为最新版本
//用来比对版本号的包
lerna add semver core/cli/
//给输出的文字添加颜色
lerna add colors core/cli/



// 检查root权限自动降级
// 在linux系统里用sudo imooc-cli-dev用root账户创建的文件就属于root账户的，其他人就无法修改了
// 检查是否是root权限登录，如果是的话就自动权限降级
// windows 上面用不了这个方法
lerna add root-check core/cli/



//user-hom检查用户主目录,path-exists判断文件是否存在
//没有用户主目录缓存之类的好多事都做不了
lerna add user-home core/cli/
lerna add path-exists core/cli/


//检查环境变量,环境变量是很重要的
//再用户主目录下创建一个环境变量.env 文件 里面写上
------
CLI_HOME=.imooc-cli
DB_USER=root
DB_PWD=123456
-----
lerna add dotenv core/cli/



//脚手架更新提醒
//把脚手架下载到本地之后有可能最新的版本已经更新了，而本地可能还并不知晓，所以要提示用户更新
lerna create get-npm-info utils


core/cli/package.json 文件里面写上
"@imooc-cli-dev-zhang/get-npm-info": "file:../../utils/get-npm-info",

//安装呼叫api的库
lerna add axios utils/get-npm-info/

//安装拼接url的库,拼接url的时候不用打斜杠
lerna add url-join utils/get-npm-info/



//命令注册
lerna add commander core/cli/


//实现init包的动态加载
lerna create @imooc-cli-dev-zhang/exec core/
lerna create @imooc-cli-dev-zhang/package models/



core/cli/package.json 文件里面写上
"@imooc-cli-dev-zhang/init": "file:../../commands/init",
"@imooc-cli-dev-zhang/exec": "file:../exec",
然后在core/cli文件夹下  npm install


models/package/package.json 文件里面写上
  "dependencies": {
    "@imooc-cli-dev-zhang/utils": "file:../../utils/utils"
  }
然后在models/package文件夹下  npm install


core/exec/package.json 文件里面写上
"dependencies": {
    "@imooc-cli-dev-zhang/package": "file:../../models/package",
    "@imooc-cli-dev-zhang/log": "file:../../utils/log"
}
然后在models/package文件夹下 npm install


lerna add pkg-dir models/package  ( 或者cd 到models/package目录下 npm install -S pkg-dir)
lerna add npminstall models/package 
lerna add path-exists models/package 
lerna add fs-extra models/package 
修改models/package.js 文件

lerna create format-path utils
将format-path包导入 models/package



// 测试命令
// imooc-test-dev  init test_projcet_name  --debug
// imooc-test-dev  init projcet_name -tp /mnt/c/Users/zhang/Desktop/imooc-test/commands/init --debug --force
// 执行 exec 

// 如果指定了target_path，就使用这个target_path下的本地的init包 (也就是/mnt/c/Users/zhang/Desktop/imooc-test/commands/init这个包)

// 如果没有指定target_path 第一次运行 imooc-test-dev  init test_projcet_name  --debug 命令

// 走的是install 将 @imooc-cli/init 这个package 下载并放入 home/zhang/.imooc-cli-dev/dependencies/node_modules，默认下载的是最新版本

// 假如第一次下载的是1.0.0版本   _@imooc-cli_init@1.1.0@@imooc-cli'

// 第二次运行 imooc-test-dev  init test_projcet_name  --debug 命令

// 去这个 home/zhang/.imooc-cli-dev/dependencies/node_modules 缓存路径下 查看最新版本的_@imooc-cli_init@1.1.2@@imooc-cli/init 这个包是否存在。

// 如果不存在就下载_@imooc-cli_init@1.1.2@@imooc-cli/init 到 home/zhang/.imooc-cli-dev/dependencies/node_modules 里面

//  dependencies/node_modules 里面就会有两个包

//   '_@imooc-cli_init@1.1.0@@imooc-cli'
//  '_@imooc-cli_init@1.1.2@@imooc-cli'

//  mnt/c/Users/zhang/Desktop/imooc-test/commands/init/lib/init.js 文件 
//或者执行 @imooc-cli_init@1.1.2@@imooc-cli/init/lib/init.js  文件



------------------------------------------------
cd 到 /home/zhang/文件夹下
rm -rf .imooc-cli-dev 删除 .imooc-cli-dev 文件夹 

1,imooc-test-dev  init test_projcet_name  --debug

  target_path不存在的时候并且指定的package(init package)在home/zhang/.imooc-cli-dev/dependencies/node_modules 这个目录也没有的时候
  第一次走的是install 将 @imooc-cli/init 这个package 下载并放入 home/zhang/.imooc-cli-dev/dependencies/node_modules，默认下载的是最新版本

2，rm -rf dependencies  (rm -rf .imooc-cli-dev 也可以)
   将  const package_version='latest'; 改为  const package_version='1.1.0';

3，imooc-test-dev  init test_projcet_name  --debug
   他就会安装1.1.0这个版本 从原来的 '_@imooc-cli_init@1.1.2@@imooc-cli'  变为 '_@imooc-cli_init@1.1.0@@imooc-cli'

4,再执行一次 imooc-test-dev  init test_projcet_name  --debug 
   他就会安装1.1.2这个版本
   dependencies/node_modules 里面就会有两个包
   '_@imooc-cli_init@1.1.0@@imooc-cli'
   '_@imooc-cli_init@1.1.2@@imooc-cli'

5, 将 const package_version='1.1.0'  改为 const package_version='latest'

// 判断target path 是否存在，如果存在就根据target path获取本地代码进行开发，如果不存在就创建缓存目录，下载package并把这个package缓存到本地。
// 在本地开发的时候，希望 init 指向的是/mnt/c/Users/zhang/Desktop/imooc-test/commands/init 这个包。
--------------------------------------









发布
发布之前要把修改的东西提交到github，也可以提交到gitee

发布之前都要对版本号进行升级
lerna version
主要选择patch ，minor ，Major 其中一个
然后弹出选项是否创建1.0.1版本，
首次选no,之后选yes

发布
使用了 orgnizition 上传的时候默认包都时private的，必须将包公开
在packages文件夹里的所有包的 package.json 里面写上
"publishConfig": {
  "access": "public"
}

npm publish 
主要选择patch ，minor ，Major 其中一个
然后弹出选项是否创建1.0.1版本，
首次选no,之后选yes


遇到版本号错误就手动升级每个package.json 文件的版本号


写代码的时候一定要用if 判断那个值存不存在，
